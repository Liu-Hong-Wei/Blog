# .github/workflows/deploy.yml

# å·¥ä½œæµåç§°
name: Deploy to VPS

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç è¢«æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches:
      - main

# å®šä¹‰å·¥ä½œä»»åŠ¡
jobs:
  deploy:
    # è¿è¡Œç¯å¢ƒï¼šä½¿ç”¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿ
    runs-on: ubuntu-latest
    # æ­¥éª¤
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      # æŠŠä»“åº“ä»£ç ä¸‹è½½åˆ° Runner ä¸­
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤2: è®¾ç½® SSH
      # é…ç½® SSH å¯†é’¥ï¼Œç”¨äºè¿æ¥åˆ° VPS
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      # æ­¥éª¤3: è¿æ¥åˆ° VPS å¹¶æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
      # é€šè¿‡ SSH åœ¨ VPS ä¸Šæ‰§è¡Œä¸€ç³»åˆ—éƒ¨ç½²æ“ä½œ
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e  # å¦‚æœä»»æ„å‘½ä»¤å¤±è´¥åˆ™ç«‹å³é€€å‡º

            echo "ğŸš€ Starting deployment on VPS..."

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /home/et/Blog
            echo "âœ… Changed directory to /home/et/Blog"

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ”„ Pulling latest code from git..."
            git pull
            echo "âœ… Code updated"

            # ä½¿ç”¨ Docker Compose é‡å¯æœåŠ¡
            echo "ğŸ³ Restarting Docker containers..."
            docker compose down
            docker compose up --build -d
            echo "âœ… Docker containers are up and running"

            # æ¸…ç†æ— ç”¨çš„ Docker é•œåƒ
            echo "ğŸ§¹ Pruning unused Docker images..."
            docker image prune -f
            echo "âœ… Cleanup complete"

            echo "ğŸ‰ Deployment finished successfully!"
          EOF