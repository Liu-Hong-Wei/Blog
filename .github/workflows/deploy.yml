# .github/workflows/deploy.yml

# 工作流名称
name: Deploy to VPS

# 触发条件：当代码被推送到 main 分支时触发
on:
  push:
    branches:
      - main

# 定义工作任务
jobs:
  deploy:
    # 运行环境：使用最新的 Ubuntu 系统
    runs-on: ubuntu-latest
    # 步骤
    steps:
      # 步骤1: 检出代码
      # 把仓库代码下载到 Runner 中
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2: 设置 SSH
      # 配置 SSH 密钥，用于连接到 VPS
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      # 步骤3: 连接到 VPS 并执行部署命令
      # 通过 SSH 在 VPS 上执行一系列部署操作
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e  # 如果任意命令失败则立即退出

            echo "🚀 Starting deployment on VPS..."

            # 进入项目目录
            cd /home/et/Blog
            echo "✅ Changed directory to /home/et/Blog"

            # 拉取最新代码
            echo "🔄 Pulling latest code from git..."
            git pull
            echo "✅ Code updated"

            # 使用 Docker Compose 重启服务
            echo "🐳 Restarting Docker containers..."
            docker compose down
            docker compose up --build -d
            echo "✅ Docker containers are up and running"

            # 清理无用的 Docker 镜像
            echo "🧹 Pruning unused Docker images..."
            docker image prune -f
            echo "✅ Cleanup complete"

            echo "🎉 Deployment finished successfully!"
          EOF